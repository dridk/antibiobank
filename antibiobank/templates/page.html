<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Test</title>
	<link rel="stylesheet" href="static/uikit/css/uikit.gradient.min.css">
	<link rel="stylesheet" href="static/css/page.css">
	<script src="static/js/jquery.min.js"></script>
	<script src="static/uikit/js/uikit.min.js"></script>
	<script src="static/js/canvasjs.min.js"></script>

</head>
<body>

	

	<div id="overlay">
		<img src="static/img/ajax-loader.gif">
	</div>

	<nav class="uk-navbar uk-fixed-navigation">
		<a class="uk-navbar-brand" href="">AntiBiobank</a>

		<ul class="uk-navbar-nav">
			<li><a href="#">A propos</a></li>
			<li><a href="#">Aide</a></li>
			<li><a href="#">Participer</a></li>
		</ul>

		<div class="uk-navbar-flip">
			<div class="navbar-content uk-hidden-small">

				<form class="uk-search">
					<input class="uk-search-field bactery_search" type="search" placeholder="BactÃ©rie ..." autocomplete="off">
					<button class="uk-search-close" type="reset"></button>
				</form>
			</div>
		</div>
	</nav>



	<div class="container">


		<div class="left">
			<div id="searchform">
				<form  action="#" class="uk-form">

					<select id="bacteries_input" class="uk-form-large field">
						<option value="volvo">Volvo</option>
						<option value="saab">Saab</option>
						<option value="mercedes">Mercedes</option>
						<option value="audi">Audi</option>

					</select>

					<select id="specimens_input" class="uk-form-large field">
					</select>

					<select id="services_input" class="uk-form-large field">
					</select>

					<input id="filter" type="text" class="uk-form-success uk-form-large" placeholder="Sensibility filter" readonly>

					<select id="filter_mode" class="uk-form-large">
						<option selected="selected" value="S">Sensible</option>
						<option value="I">Intermediaire</option>
						<option value="R">Resistant</option>

					</select>

					<button id="getButton" class="uk-button  uk-width-1-1" 
					onclick="return false">Rechercher</button>


				</form>
			</div>



			<ul class="uk-nav uk-nav-side uk-subnav-pill" id="atb_list">
				<li class="uk-nav-divider"></li>
				<li class="uk-nav-header">Antibiotique</li>
				<li id="amox"><a>Amoxicilline</a></li>
				<li id="cefo"><a>Cefotaxime</a></li>
			</ul>




		</div>


		<div class="main">

			<ul class="uk-subnav uk-subnav-line" id="subnav">
				<li><a href="">Staphylococcus</a></li>
				<li><a href="">RESP</a></li>
				<li><span>Pediatrie</span></li>
			</ul>


			<div class="uk-grid" id="box_container">

			<!-- 	<div class="uk-width-custom uk-grid-margin" style="width:300px;display:none" id="box_template">
					<div class="uk-panel uk-panel-box" >
						<div id="{CHARTID}" style="height: 300px; width: 100%;">
					

						</div>
					</div>
				</div> -->


			</div>

		</div>






	</div>

	<script>

// ====================================================================

function get_stats(){

	send = {}
	send["bactery_id"]  = $("#bacteries_input").val();;
	send["specimen_id"] = $("#specimens_input").val();
	send["service_id"]  = $("#services_input").val();
	send["filter_mode"] = $("#filter_mode").val();

	filter_ids = []

	$("#atb_list li.uk-active").each(function(){

		filter_ids.push($(this).attr("value"))
	})

	send["filter_ids"] = filter_ids

	console.debug(send)



	$('#overlay').show();
	$("#atb_list").empty();
	$("#box_container").empty();

	$.post("ajax_stats.json",send, function(results,status){
		

		load_atb(results)
		load_chart(results);

	})
	.always(function() {
		$('.overlay').css({"visibility":"hidden"});	

	})

	.fail(function() {
		$('.overlay').css({"visibility":"hidden"});	

	})
	;


}
// ====================================================================
function load_atb(results){

	for (var i=0; i<results.data.length; i++)
		$("#atb_list").append("<li value="+results.data[i].id+"><a href='#'>"+results.data[i].name+"</a></li>")

}
// ====================================================================

function load_chart(results){

	var strVar="";
	strVar += "<div class=\"uk-width-custom uk-grid-margin\" style=\"width:300px;display:none\" id=\"box_template\">";
	strVar += "					<div class=\"uk-panel uk-panel-box\" >";
	strVar += "						<div id=\"{CHARTID}\" style=\"height: 300px; width: 100%;\">";
	strVar += "						<\/div>";
	strVar += "					<\/div>";

	box_template = strVar;
	console.debug(results)

	for (var i=0; i<results.data.length; i+=1)
	{
		box = box_template.replace("display:none", "");
		box = box.replace("{CHARTID}", "chart-"+i);
		
		if ($("#chart-"+i).length == 0)  // If existe deja, on refait pas
			$("#box_container").append(box);

		var chart = new CanvasJS.Chart("chart-"+i,
		{
			title:{
				text: results.data[i].name
			},
			legend:{
				verticalAlign: "top",
				horizontalAlign: "center"
			},
			data: [
			{
				type: "doughnut",
				showInLegend:true,
				dataPoints: [
				{  y: results.data[i].S, indexLabel: "S", color:"#98cb4a", legendText:"Sensible"},
				{  y: results.data[i].R ,indexLabel: "R" , color:"#f26075", legendText:"Resistant"},
				{  y: results.data[i].I, indexLabel: "I" , color:"#849199", legendText:"Intermediaire"},

				]
			}
			]
		});

		chart.render();

	}

}

// ====================================================================


$(document).ready(function(){


	

	$( "#getButton" ).click(function() {
		get_stats()
	});


		$("#filter").empty();

	$('#atb_list').on('click','li',function() {

		element =$(this);
		element.toggleClass("uk-active");
		text =[]
		$("#atb_list li.uk-active").each(function(){
			text.push($(this).text())
		});


		$("#filter").val(text.join(","))

	});
	


	console.debug("salut");
	$('#overlay').hide();



	$("#bacteries_input").empty();
	$("#bacteries_input").empty();
	$("#bacteries_input").empty();

	$.getJSON("ajax_bacteries.json", function(data) {
		for (var i=0; i<data.results.length; i+=1)
			$("#bacteries_input").append("<option value='"+data.results[i].id+"'>"+data.results[i].name+"</option>")

	});

	$.getJSON("ajax_services.json", function(data) {
		for (var i=0; i<data.results.length; i+=1)
			$("#services_input").append("<option value='"+data.results[i].id+"'>"+data.results[i].name+"</option>")
	});

	$.getJSON("ajax_specimens.json", function(data) {
		for (var i=0; i<data.results.length; i+=1)
			$("#specimens_input").append("<option value='"+data.results[i].id+"'>"+data.results[i].name+"</option>")
	});
















})

</script>

</body>






</html>
